# Smart Keyframe Extractor - 基准测试套件

这个目录包含了 Smart Keyframe Extractor 的全面基准测试和压力测试工具。

## 🗂️ 测试工具概览

### 1. 快速基准测试 (`quick_benchmark.py`)
- **用途**: 快速评估基本性能
- **特点**: 
  - 轻量级，无需额外依赖
  - 测试不同配置的性能对比
  - 生成基本的性能报告
- **适用场景**: 日常开发、快速性能检查

### 2. 内存压力测试 (`memory_stress_test.py`) 
- **用途**: 检查内存泄漏和大量处理的稳定性
- **特点**:
  - 连续处理测试
  - 批量处理测试
  - 内存增长趋势分析
- **适用场景**: 生产环境部署前的稳定性测试

### 3. 完整压力测试 (`stress_test.py`)
- **用途**: 全面的性能分析和压力测试
- **特点**:
  - 自动创建不同规格的测试视频
  - 多种配置的综合测试
  - 详细的性能图表和报告
- **依赖**: `matplotlib`, `pandas`
- **适用场景**: 深度性能分析、优化前后对比

### 4. 并发压力测试 (`concurrent_stress_test.py`)
- **用途**: 多线程并发处理和大规模测试
- **特点**:
  - 支持多视频文件并发处理
  - 实时系统资源监控
  - 持续负载和突发负载测试
  - 详细的并发性能分析
- **依赖**: `psutil`
- **适用场景**: 生产环境并发能力验证

### 5. 云服务器压力测试 (`cloud_stress_test.py`)
- **用途**: 专为云服务器环境设计的大规模压力测试
- **特点**:
  - 自动发现多目录视频文件
  - 多种预设测试配置档案
  - 支持自定义测试配置
  - 完整的命令行接口
  - 适合自动化部署
- **依赖**: `psutil`, `pandas`
- **适用场景**: 云服务器性能验证、生产环境压力测试

## 🚀 快速开始

### 使用统一入口
```bash
cd /Users/jiajunchen/Code/smart_frame
python benchmark/run_tests.py
```

### 直接运行单个测试
```bash
# 快速基准测试
python benchmark/quick_benchmark.py

# 内存压力测试  
python benchmark/memory_stress_test.py

# 完整压力测试 (需要安装额外依赖)
pip install matplotlib pandas
python benchmark/stress_test.py

# 并发压力测试 (需要安装额外依赖)
pip install psutil
python benchmark/concurrent_stress_test.py

# 云服务器压力测试
python benchmark/cloud_stress_test.py --video-dirs /path/to/videos
```

### 云服务器一键部署
```bash
# 部署云服务器测试环境
bash deploy_cloud_stress_test.sh

# 运行云服务器压力测试
./run_stress_test.sh /path/to/videos
```

## 📋 测试前准备

### 1. 确保有测试视频
将测试视频放在 `videos/` 目录下，例如：
```
videos/
└── 785023.mp4
```

### 2. 安装依赖 (可选)
```bash
# 基础测试不需要额外依赖
# 完整测试需要:
pip install matplotlib pandas psutil
```

## 📊 测试结果

### 输出目录
测试结果会保存在以下目录:
- `benchmark_results/` - JSON和CSV格式的详细结果
- 图表文件 (如果运行完整测试)

### 关键指标
- **执行时间**: 处理视频所需的总时间
- **内存使用**: 内存峰值和增长情况
- **处理速度**: 每秒处理的帧数 (FPS)
- **效率分数**: 每秒提取的关键帧数
- **成功率**: 测试成功的百分比

## 🎯 测试场景说明

### 快速基准测试场景
1. **基本性能测试**: 使用默认参数测试单个视频
2. **配置对比测试**: 对比不同K值和分辨率的性能影响

### 内存压力测试场景  
1. **连续处理测试**: 多次连续处理同一视频，检查内存泄漏
2. **批量处理测试**: 测试不同批量大小的内存表现

### 完整压力测试场景
1. **多规格视频测试**: 自动创建不同分辨率、时长的测试视频
2. **多配置测试**: 测试各种参数组合的性能
3. **压力测试**: 重复执行相同任务检查稳定性

## 📈 性能优化建议

根据测试结果，以下是一些优化建议：

### 如果内存使用过高
- 降低视频分辨率 (`resolution` 参数)
- 减少提取的关键帧数量 (`k` 参数)
- 分批处理大量视频

### 如果处理速度太慢
- 使用较低的分辨率设置
- 减少关键帧数量
- 考虑使用 GPU 加速 (如果可用)

### 如果检测到内存泄漏
- 及时清理临时文件
- 在批量处理中定期调用垃圾回收
- 避免长时间运行大量处理任务

## 🔧 自定义测试

你可以修改测试参数来适应特定需求：

```python
# 在 quick_benchmark.py 中修改测试配置
configs = [
    {"k": 3, "resolution": "original", "name": "原始分辨率_3帧"},
    {"k": 5, "resolution": "720p", "name": "720p分辨率_5帧"},
    # 添加你的自定义配置
]
```

## 📝 报告解读

### 性能指标含义
- **执行时间**: 越短越好
- **内存使用**: 应该保持在合理范围内
- **处理速度**: 越高越好 (fps)
- **效率分数**: 每秒提取的有效关键帧数

### 警告信号
- ⚠️ 内存增长率 > 10%: 可能存在内存泄漏
- ⚠️ 成功率 < 90%: 系统可能不稳定
- ⚠️ 处理速度持续下降: 可能有性能问题

## 🤝 贡献

如果你想添加新的测试场景或改进现有测试，欢迎提交PR！
